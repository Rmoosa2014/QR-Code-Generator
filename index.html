<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ILLUS QR CODE STUDIO</title>
    
    <!-- External Libraries for Advanced Features -->
    <script src="https://unpkg.com/qr-code-styling@1.5.0/lib/qr-code-styling.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        :root {
            --primary-green: #6eb944;
            --primary-gray: #414042;
            --bg-light: #f4f4f4;
            --white: #ffffff;
            --border: #e0e0e0;
            --text-muted: #888888;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; }

        body {
            background-color: var(--bg-light); color: var(--primary-gray); height: 100vh; width: 100vw;
            overflow: hidden; display: flex; flex-direction: column; align-items: center; padding: 15px;
        }

        header { text-align: center; margin-bottom: 15px; flex-shrink: 0; }
        h1 { color: var(--primary-gray); font-size: 1.8rem; font-weight: 800; letter-spacing: -0.5px; margin: 0; text-transform: uppercase; line-height: 1.2; }
        h1 span { color: var(--primary-green); }
        p.subtitle { color: var(--text-muted); font-size: 0.85rem; margin-top: 2px; }

        .app-container {
            max-width: 1000px; width: 100%; height: 100%; display: grid; grid-template-columns: 1fr 1fr;
            gap: 20px; overflow: hidden; padding-bottom: 5px;
        }

        @media (max-width: 900px) {
            .app-container { grid-template-columns: 1fr; overflow-y: auto; display: block; padding-bottom: 20px; }
            body { height: auto; overflow-y: auto; }
        }

        .card {
            background: var(--white); border-radius: 12px; padding: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            border: 1px solid var(--border); display: flex; flex-direction: column; overflow: hidden; height: 100%;
        }

        .card-content { display: flex; flex-direction: column; gap: 12px; height: 100%; overflow-y: auto; padding-right: 5px; }
        .card-content::-webkit-scrollbar { width: 6px; }
        .card-content::-webkit-scrollbar-track { background: transparent; }
        .card-content::-webkit-scrollbar-thumb { background: #e0e0e0; border-radius: 3px; }

        .card-header {
            display: flex; align-items: center; justify-content: space-between; gap: 8px; margin-bottom: 15px;
            padding-bottom: 10px; border-bottom: 1px solid var(--bg-light); color: var(--primary-gray); flex-shrink: 0;
        }
        .card-title { font-size: 1rem; font-weight: 700; text-transform: uppercase; display: flex; align-items: center; gap: 8px; }

        .type-switcher { display: flex; background: var(--bg-light); padding: 3px; border-radius: 8px; }
        .type-btn {
            padding: 6px 12px; font-size: 0.75rem; font-weight: 700; cursor: pointer; border-radius: 6px;
            border: none; background: transparent; color: #888; transition: all 0.2s;
        }
        .type-btn.active { background: var(--white); color: var(--primary-green); box-shadow: 0 2px 5px rgba(0,0,0,0.05); }

        .hidden-section { display: none; }
        label { display: block; font-size: 0.7rem; font-weight: 700; color: var(--text-muted); margin-bottom: 4px; text-transform: uppercase; letter-spacing: 0.5px; }
        .input-wrapper { position: relative; }
        input[type="text"], input[type="url"], input[type="file"] {
            width: 100%; padding: 8px 10px; border: 2px solid var(--bg-light); border-radius: 6px;
            font-size: 0.85rem; transition: all 0.2s; outline: none; color: var(--primary-gray); background: #fff;
        }
        input:focus { border-color: var(--primary-green); }
        .helper-text { font-size: 0.65rem; color: #aaa; margin-top: 2px; text-align: right; }

        .checkbox-wrapper { display: flex; align-items: center; gap: 8px; margin-bottom: 6px; cursor: pointer; }
        input[type="checkbox"] { accent-color: var(--primary-green); width: 14px; height: 14px; cursor: pointer; }

        .options-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 6px; }
        .option-btn {
            padding: 6px 2px; border: 2px solid var(--bg-light); background: var(--white); border-radius: 6px;
            cursor: pointer; text-align: center; font-weight: 600; font-size: 0.75rem; color: #666;
            transition: all 0.2s; text-transform: capitalize; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }
        .option-btn:hover { border-color: #ddd; }
        .option-btn.active { border-color: var(--primary-green); background-color: #f0f9eb; color: var(--primary-green); }

        .color-row { display: flex; gap: 8px; flex-wrap: wrap; align-items: center; }
        .color-dot { width: 26px; height: 26px; border-radius: 50%; cursor: pointer; border: 2px solid transparent; transition: transform 0.2s; }
        .color-dot:hover { transform: scale(1.1); }
        .color-dot.active { border-color: var(--primary-gray); transform: scale(1.1); }

        .custom-picker-wrapper {
            position: relative; width: 28px; height: 28px; border-radius: 50%;
            background: conic-gradient(red, yellow, lime, aqua, blue, magenta, red);
            border: 2px solid var(--border); cursor: pointer; margin-left: auto;
            display: flex; align-items: center; justify-content: center;
        }
        .custom-picker-wrapper::after { content: '+'; color: white; font-weight: bold; font-size: 12px; text-shadow: 0 1px 1px rgba(0,0,0,0.5); }
        input[type="color"] { position: absolute; inset: 0; opacity: 0; width: 100%; height: 100%; cursor: pointer; }

        .preview-wrapper { position: relative; }
        .preview-content { display: flex; flex-direction: column; justify-content: center; height: 100%; }
        .qr-stage {
            background-image: radial-gradient(#e0e0e0 1px, transparent 1px); background-size: 20px 20px;
            background-color: #fcfcfc; border-radius: 12px; flex: 1; display: flex; flex-direction: column;
            align-items: center; justify-content: center; margin-bottom: 15px; position: relative;
            border: 1px solid var(--bg-light); min-height: 200px; overflow: hidden;
        }
        .qr-canvas-container {
            padding: 10px; background: white; border-radius: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            transition: transform 0.3s; max-width: 90%; max-height: 90%; display: flex; align-items: center; justify-content: center;
        }
        .qr-canvas-container canvas, .qr-canvas-container svg { max-width: 100%; max-height: 100%; height: auto; width: auto; display: block; }

        .refresh-btn {
            position: absolute; top: 10px; right: 10px; background: white; border: 1px solid var(--border);
            border-radius: 50%; width: 28px; height: 28px; display: flex; align-items: center; justify-content: center;
            cursor: pointer; color: #666; z-index: 5;
        }
        .status-pill {
            position: absolute; bottom: 10px; background: rgba(240, 249, 235, 0.9); color: var(--primary-green);
            padding: 4px 10px; border-radius: 12px; font-size: 0.7rem; font-weight: 700; backdrop-filter: blur(2px);
        }

        .btn-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-top: auto; flex-shrink: 0; }
        .action-btn {
            display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 10px 6px;
            border-radius: 8px; border: none; cursor: pointer; transition: all 0.2s; text-decoration: none;
        }
        .action-btn i { margin-bottom: 3px; width: 18px; height: 18px; }
        .btn-primary { background-color: var(--primary-gray); color: white; }
        .btn-primary:hover { background-color: #2d2d2d; }
        .btn-secondary { background-color: var(--white); border: 2px solid var(--bg-light); color: var(--primary-gray); }
        .btn-secondary:hover { border-color: var(--primary-gray); }
        .btn-danger { background-color: #fff5f5; color: #c53030; border: 2px solid #fff5f5; }
        .btn-danger:hover { border-color: #feb2b2; }
        .btn-label { font-size: 0.6rem; opacity: 0.7; }
        .btn-text { font-weight: 700; font-size: 0.8rem; }
        
        .compact-logo-inputs { display: grid; grid-template-columns: 1fr auto 1fr; gap: 6px; align-items: center; }
        .compact-or { font-size: 0.65rem; color: #ccc; font-weight: 600; }
    </style>
</head>
<body>

    <header>
        <h1>ILLUS <span>QR CODE STUDIO</span></h1>
        <p class="subtitle">Professional QR & Barcode Generator</p>
    </header>

    <div class="app-container">
        
        <!-- LEFT: Configuration -->
        <div class="card">
            <div class="card-header">
                <span class="card-title"><i data-lucide="sliders-horizontal" width="18"></i>Configuration</span>
                <div class="type-switcher">
                    <button class="type-btn active" id="btn-mode-qr" onclick="setMode('qr')">QR CODE</button>
                    <button class="type-btn" id="btn-mode-barcode" onclick="setMode('barcode')">BARCODE</button>
                </div>
            </div>

            <div class="card-content">
                <div class="form-section">
                    <label id="contentLabel">Target URL</label>
                    <div class="input-wrapper">
                        <input type="text" id="urlInput" value="Enjoy the new QR" placeholder="Enter text or URL">
                    </div>
                </div>

                <!-- QR: Logo -->
                <div class="form-section qr-only">
                    <label>Center Logo</label>
                    <div class="checkbox-wrapper">
                        <input type="checkbox" id="useFavicon">
                        <span style="font-size: 0.8rem; color: var(--primary-gray);">Auto-fetch</span>
                    </div>
                    <div id="customLogoGroup" style="opacity: 1;">
                        <div class="compact-logo-inputs">
                            <input type="url" id="logoUrlInput" placeholder="Image URL">
                            <span class="compact-or">OR</span>
                            <input type="file" id="logoFileInput" accept="image/*" style="padding: 6px;">
                        </div>
                    </div>
                </div>

                <!-- QR: Patterns -->
                <div class="form-section qr-only">
                    <label>Pattern Style</label>
                    <div class="options-grid" id="dotTypeContainer"></div>
                </div>

                <!-- QR: Corners -->
                <div class="form-section qr-only">
                    <label>Corner Style</label>
                    <div class="options-grid" id="cornerTypeContainer"></div>
                </div>

                <!-- BARCODE: Type Selector -->
                <div class="form-section barcode-only hidden-section">
                    <label>Barcode Standard</label>
                    <div class="options-grid" style="grid-template-columns: 1fr 1fr;">
                        <div class="option-btn active" id="btn-bc-code128" onclick="setBarcodeType('code128')">Code 128 (Text)</div>
                        <div class="option-btn" id="btn-bc-ean13" onclick="setBarcodeType('ean13')">EAN-13 / UPC (Product)</div>
                    </div>
                </div>

                <!-- BARCODE: Text Toggle -->
                <div class="form-section barcode-only hidden-section">
                    <div class="checkbox-wrapper">
                        <input type="checkbox" id="showBarcodeText" checked onchange="updateView()">
                        <span style="font-size: 0.8rem; color: var(--primary-gray);">Show Text Below Barcode</span>
                    </div>
                </div>

                <div class="form-section">
                    <label>Primary Color</label>
                    <div class="color-row">
                        <div id="colorPresets" style="display: contents;"></div>
                        <div class="custom-picker-wrapper" title="Custom Color">
                            <input type="color" id="colorPicker" value="#6eb944">
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- RIGHT: Preview -->
        <div class="card preview-wrapper">
            <div class="card-header">
                <span class="card-title"><i data-lucide="eye" width="18"></i>Preview</span>
            </div>
            <div class="preview-content">
                <div class="qr-stage">
                    <button class="refresh-btn" onclick="forceRefresh()" title="Redraw"><i data-lucide="refresh-cw" width="14"></i></button>
                    <div class="qr-canvas-container" id="qr-container"></div>
                    <div class="status-pill" id="statusPill">Ready to Scan</div>
                </div>
                <div class="btn-grid">
                    <button class="action-btn btn-primary" onclick="handleDownload('png')"><i data-lucide="image"></i><span class="btn-label">Download</span><span class="btn-text">PNG</span></button>
                    <button class="action-btn btn-secondary" onclick="handleDownload('svg')"><i data-lucide="file-code"></i><span class="btn-label">Download</span><span class="btn-text">SVG</span></button>
                    <button class="action-btn btn-danger" onclick="handleDownload('pdf')"><i data-lucide="file-text"></i><span class="btn-label">Save as</span><span class="btn-text">PDF</span></button>
                </div>
            </div>
        </div>
    </div>

    <!-- APP LOGIC -->
    <script>
        // --- Barcode Engine ---
        const BarcodeEngine = {
            // Code 128 (Subset B)
            code128: {
                patterns: ["212222","222122","222221","121223","121322","131222","122213","122312","132212","221213","221312","231212","112232","122132","122231","113222","123122","123221","223211","221132","221231","213212","223112","312131","311222","321122","321221","312212","322112","322211","212123","212321","232121","111323","131123","131321","112313","132113","132311","211313","231113","231311","112133","112331","132131","113123","113321","133121","313121","211331","231131","213113","213311","213131","311123","311321","331121","312113","312311","332111","314111","221411","431111","111224","111422","121124","121421","141122","141221","112214","112412","122114","122411","142112","142211","241211","221114","413111","241112","134111","111242","121142","121241","114212","124112","124211","411212","421112","421211","212141","214121","412121","111143","111341","131141","114113","114311","411113","411311","113141","114131","311141","411131","211412","211214","211232","2331112"],
                encode: function(text) {
                    let checksum=104, patternIds=[104];
                    for (let i=0; i<text.length; i++) {
                        let code = text.charCodeAt(i)-32;
                        if(code<0 || code>94) code=0;
                        patternIds.push(code); checksum += code*(i+1);
                    }
                    patternIds.push(checksum%103); patternIds.push(106);
                    let bin = "";
                    for(let pid of patternIds) bin += this.patternToBin(this.patterns[pid]);
                    return bin;
                },
                patternToBin: function(p) {
                    let b = ""; for(let i=0;i<p.length;i++) b += (i%2===0) ? "1".repeat(parseInt(p[i])) : "0".repeat(parseInt(p[i])); return b;
                }
            },

            // EAN-13 / UPC-A
            ean13: {
                L: ["0001101","0011001","0010011","0111101","0100011","0110001","0101111","0111011","0110111","0001011"],
                G: ["0100111","0110011","0011011","0100001","0011101","0111001","0000101","0010001","0001001","0010111"],
                R: ["1110010","1100110","1101100","1000010","1011100","1001110","1010000","1000100","1001000","1110100"],
                structure: ["LLLLLL","LLGLGG","LLGGLG","LLGGGL","LGLLGG","LGGLLG","LGGGLL","LGLGLG","LGLGGL","LGGLGL"],
                guard: { start: "101", mid: "01010", end: "101" },

                validate: function(text) {
                    let clean = text.replace(/[^0-9]/g, '');
                    if (clean.length === 11 || clean.length === 12) {
                        let sum = 0;
                        let padded = clean.padStart(12, '0').slice(0, 12);
                        for(let i=0; i<12; i++) sum += parseInt(padded[i]) * (i % 2 === 0 ? 1 : 3);
                        let check = (10 - (sum % 10)) % 10;
                        if (clean.length === 11) return clean + check;
                        if (clean.length === 12 && parseInt(clean[11]) === check) return clean;
                        if (clean.length === 12) return clean.slice(0,11) + check;
                    }
                    if (clean.length === 13) return clean;
                    return "6285622049321"; // Default EAN
                },

                encode: function(text) {
                    let data = this.validate(text);
                    if (data.length === 12) data = "0" + data; 
                    if (data.length !== 13) data = "0000000000000";

                    let first = parseInt(data[0]);
                    let left = data.slice(1, 7);
                    let right = data.slice(7, 13);
                    let struct = this.structure[first];

                    let bin = this.guard.start;
                    for (let i=0; i<6; i++) {
                        let digit = parseInt(left[i]);
                        bin += (struct[i] === 'L') ? this.L[digit] : this.G[digit];
                    }
                    bin += this.guard.mid;
                    for (let i=0; i<6; i++) {
                        bin += this.R[parseInt(right[i])];
                    }
                    bin += this.guard.end;
                    return { bin, display: data };
                }
            },

            draw: function(text, canvas, color, showText, type) {
                const ctx = canvas.getContext('2d');
                let encoded, bin, displayText;

                if (type === 'ean13') {
                    const res = this.ean13.encode(text);
                    bin = res.bin;
                    displayText = res.display;
                } else {
                    bin = this.code128.encode(text);
                    displayText = text;
                }

                const moduleWidth = type === 'ean13' ? 3 : 2;
                const quietZone = type === 'ean13' ? 40 : 20; 
                const width = bin.length * moduleWidth + (quietZone * 2);
                const height = 150;
                
                canvas.width = width;
                canvas.height = height;

                ctx.fillStyle = '#ffffff';
                ctx.fillRect(0, 0, width, height);
                ctx.fillStyle = color;

                for(let i=0; i<bin.length; i++) {
                    if(bin[i] === "1") {
                        let h = height - (showText ? 35 : 20);
                        if (type === 'ean13') {
                            if (i < 3 || (i >= 45 && i < 50) || i >= 92) {
                                h = height - 10; 
                            } else {
                                h = height - 40; 
                            }
                        }
                        ctx.fillRect(quietZone + (i * moduleWidth), 10, moduleWidth, h);
                    }
                }

                if(showText) {
                    ctx.fillStyle = '#000';
                    if (type === 'ean13') {
                        ctx.font = 'bold 20px monospace'; // Smaller font to prevent overlap
                        const digitWidth = moduleWidth * 7;
                        
                        // 1. First digit
                        ctx.fillText(displayText[0], quietZone - 30, height - 12);
                        
                        // 2. Left Group
                        let startX = quietZone + (3 * moduleWidth);
                        for(let i=0; i<6; i++) {
                            let cx = startX + (i * digitWidth) + (digitWidth/2) - 10; 
                            ctx.fillText(displayText[i+1], cx, height - 12);
                        }

                        // 3. Right Group
                        startX = quietZone + (50 * moduleWidth);
                        for(let i=0; i<6; i++) {
                            let cx = startX + (i * digitWidth) + (digitWidth/2) - 10;
                            ctx.fillText(displayText[i+7], cx, height - 12);
                        }

                    } else {
                        ctx.font = 'bold 16px monospace';
                        ctx.textAlign = 'center';
                        ctx.fillText(displayText, width / 2, height - 8);
                    }
                }
            },
            
            toSVGString: function(text, color, showText, type) {
                let bin, displayText;
                if (type === 'ean13') {
                    const res = this.ean13.encode(text);
                    bin = res.bin; displayText = res.display;
                } else {
                    bin = this.code128.encode(text); displayText = text;
                }

                const moduleWidth = type === 'ean13' ? 3 : 2;
                const quietZone = type === 'ean13' ? 40 : 20;
                const width = bin.length * moduleWidth + (quietZone * 2);
                const height = 150;
                
                let svg = `<svg xmlns="http://www.w3.org/2000/svg" width="${width}" height="${height}" viewBox="0 0 ${width} ${height}">`;
                svg += `<rect width="100%" height="100%" fill="#ffffff"/>`;
                
                for(let i=0; i<bin.length; i++) {
                    if(bin[i] === "1") {
                        const x = quietZone + (i * moduleWidth);
                        let h = height - (showText ? 35 : 20);
                        if (type === 'ean13') {
                            if (i < 3 || (i >= 45 && i < 50) || i >= 92) h = height - 10;
                            else h = height - 40;
                        }
                        svg += `<rect x="${x}" y="10" width="${moduleWidth}" height="${h}" fill="${color}"/>`;
                    }
                }
                
                if(showText) {
                    if (type === 'ean13') {
                        const digitWidth = moduleWidth * 7;
                        
                        svg += `<text x="${quietZone - 30}" y="${height-12}" font-family="monospace" font-weight="bold" font-size="26" fill="#000">${displayText[0]}</text>`;
                        
                        let startX = quietZone + (3 * moduleWidth);
                        for(let i=0; i<6; i++) {
                            let cx = startX + (i * digitWidth) + (digitWidth/2); 
                            svg += `<text x="${cx}" y="${height-12}" font-family="monospace" font-weight="bold" font-size="26" text-anchor="middle" fill="#000">${displayText[i+1]}</text>`;
                        }

                        startX = quietZone + (50 * moduleWidth);
                        for(let i=0; i<6; i++) {
                            let cx = startX + (i * digitWidth) + (digitWidth/2);
                            svg += `<text x="${cx}" y="${height-12}" font-family="monospace" font-weight="bold" font-size="26" text-anchor="middle" fill="#000">${displayText[i+7]}</text>`;
                        }

                    } else {
                        svg += `<text x="${width/2}" y="${height-8}" font-family="monospace" font-weight="bold" font-size="16" text-anchor="middle" fill="#000">${displayText}</text>`;
                    }
                }
                svg += `</svg>`;
                return svg;
            }
        };

        // --- State ---
        const state = {
            mode: 'qr',
            barcodeType: 'code128',
            url: 'Enjoy the new QR',
            logoUrl: '',
            useFavicon: false,
            dotType: 'dots',
            dotColor: '#6eb944', 
            cornerType: 'extra-rounded',
            cornerColor: '#6eb944',
            bgColor: '#ffffff',
            showBarcodeText: true
        };

        let qrCode = null;
        let debounceTimer;

        // --- Config ---
        const dotTypes = ['dots', 'rounded', 'classy', 'classy-rounded', 'square', 'extra-rounded'];
        const cornerTypes = ['square', 'extra-rounded', 'dot'];
        const presetColors = ['#6eb944', '#414042', '#000000', '#2563EB', '#DB2777'];

        // --- Elements ---
        const els = {
            url: document.getElementById('urlInput'),
            useFavicon: document.getElementById('useFavicon'),
            customLogoGroup: document.getElementById('customLogoGroup'),
            logoUrl: document.getElementById('logoUrlInput'),
            logoFile: document.getElementById('logoFileInput'),
            container: document.getElementById('qr-container'),
            status: document.getElementById('statusPill'),
            colorPicker: document.getElementById('colorPicker'),
            contentLabel: document.getElementById('contentLabel'),
            showBarcodeText: document.getElementById('showBarcodeText')
        };

        // --- Init ---
        window.onload = () => {
            lucide.createIcons();
            els.colorPicker.addEventListener('input', (e) => setColor(e.target.value));
            renderUIOptions();
            
            qrCode = new QRCodeStyling({
                width: 300, height: 300, type: 'svg', data: state.url,
                dotsOptions: { color: state.dotColor, type: state.dotType },
                backgroundOptions: { color: state.bgColor },
                imageOptions: { crossOrigin: 'anonymous', margin: 10 },
                cornersSquareOptions: { type: state.cornerType, color: state.cornerColor }
            });

            updateView();
        };

        // --- Logic ---
        function setMode(mode) {
            state.mode = mode;
            document.querySelectorAll('.type-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(`btn-mode-${mode}`).classList.add('active');
            
            const qrFields = document.querySelectorAll('.qr-only');
            const barcodeFields = document.querySelectorAll('.barcode-only');
            
            if (mode === 'qr') {
                qrFields.forEach(el => el.classList.remove('hidden-section'));
                barcodeFields.forEach(el => el.classList.add('hidden-section'));
                els.contentLabel.innerText = "Target URL";
                if (state.dotColor === '#000000') setColor('#6eb944');
                updateInputValue("Enjoy the new QR");
            } else {
                qrFields.forEach(el => el.classList.add('hidden-section'));
                barcodeFields.forEach(el => el.classList.remove('hidden-section'));
                els.contentLabel.innerText = "Barcode Content";
                setColor('#000000');
                // Default to Code 128 when switching to barcode
                setBarcodeType('code128');
            }
            updateView();
        }

        function updateInputValue(val) {
            state.url = val;
            els.url.value = val;
        }

        function setBarcodeType(type) {
            state.barcodeType = type;
            document.getElementById('btn-bc-code128').classList.toggle('active', type === 'code128');
            document.getElementById('btn-bc-ean13').classList.toggle('active', type === 'ean13');
            
            // Set Specific Defaults
            if (type === 'code128') {
                updateInputValue("ILS123456");
            } else {
                updateInputValue("6285622049321");
            }
            updateView();
        }

        async function updateView() {
            els.container.innerHTML = ''; 

            if (state.mode === 'qr') {
                let activeLogo = undefined;
                if (state.useFavicon && state.url && state.url.includes('.')) {
                    try {
                        const domain = new URL(state.url).hostname;
                        activeLogo = `https://www.google.com/s2/favicons?domain=${domain}&sz=64`;
                    } catch(e) {}
                } else if (state.logoUrl) {
                    activeLogo = state.logoUrl;
                }
                const base64Logo = activeLogo ? await convertImageToBase64(activeLogo) : undefined;

                qrCode.update({
                    data: state.url,
                    image: base64Logo,
                    dotsOptions: { color: state.dotColor, type: state.dotType },
                    cornersSquareOptions: { type: state.cornerType, color: state.cornerColor },
                    backgroundOptions: { color: state.bgColor }
                });
                qrCode.append(els.container);
            } else {
                const canvas = document.createElement('canvas');
                let content = state.url || "123456";
                // Validation handled inside draw
                BarcodeEngine.draw(content, canvas, state.dotColor, els.showBarcodeText.checked, state.barcodeType);
                els.container.appendChild(canvas);
            }
        }

        function forceRefresh() { updateView(); }

        function renderUIOptions() {
            const dotContainer = document.getElementById('dotTypeContainer');
            dotContainer.innerHTML = dotTypes.map(type => `<div class="option-btn ${state.dotType === type ? 'active' : ''}" onclick="setOption('dotType', '${type}')">${type.replace('-', ' ')}</div>`).join('');

            const cornerContainer = document.getElementById('cornerTypeContainer');
            cornerContainer.innerHTML = cornerTypes.map(type => `<div class="option-btn ${state.cornerType === type ? 'active' : ''}" onclick="setOption('cornerType', '${type}')">${type.replace('-', ' ')}</div>`).join('');

            const presetsContainer = document.getElementById('colorPresets');
            presetsContainer.innerHTML = presetColors.map(color => `<div class="color-dot ${state.dotColor === color ? 'active' : ''}" style="background-color: ${color};" onclick="setColor('${color}')"></div>`).join('');
        }

        window.setOption = (key, value) => { state[key] = value; renderUIOptions(); updateView(); };

        window.setColor = (color) => {
            state.dotColor = color; state.cornerColor = color;
            els.colorPicker.value = color; 
            renderUIOptions(); updateView();
        };

        els.url.addEventListener('input', (e) => { clearTimeout(debounceTimer); state.url = e.target.value; debounceTimer = setTimeout(updateView, 300); });
        els.useFavicon.addEventListener('change', (e) => { state.useFavicon = e.target.checked; els.customLogoGroup.style.opacity = state.useFavicon ? '0.5' : '1'; els.customLogoGroup.style.pointerEvents = state.useFavicon ? 'none' : 'auto'; updateView(); });
        els.logoUrl.addEventListener('input', (e) => { state.logoUrl = e.target.value; updateView(); });
        els.logoFile.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (evt) => { state.logoUrl = evt.target.result; updateView(); };
                reader.readAsDataURL(file);
            }
        });

        async function convertImageToBase64(url) {
            if (url.startsWith('data:')) return url;
            try {
                const response = await fetch(url);
                const blob = await response.blob();
                return new Promise((resolve) => {
                    const reader = new FileReader();
                    reader.onloadend = () => resolve(reader.result);
                    reader.readAsDataURL(blob);
                });
            } catch (error) { return url; }
        }

        window.handleDownload = async (format) => {
            els.status.innerText = "Generating...";
            els.status.style.background = "#fff3cd";

            if (state.mode === 'qr') {
                let activeLogo = undefined;
                if (state.useFavicon && state.url && state.url.includes('.')) {
                    try { const domain = new URL(state.url).hostname; activeLogo = `https://www.google.com/s2/favicons?domain=${domain}&sz=64`; } catch(e) {}
                } else if (state.logoUrl) { activeLogo = state.logoUrl; }
                const base64Logo = activeLogo ? await convertImageToBase64(activeLogo) : undefined;
                const dlQr = new QRCodeStyling({
                    width: 2000, height: 2000, type: 'svg', data: state.url, image: base64Logo,
                    dotsOptions: { color: state.dotColor, type: state.dotType },
                    backgroundOptions: { color: state.bgColor },
                    cornersSquareOptions: { type: state.cornerType, color: state.cornerColor },
                    imageOptions: { crossOrigin: 'anonymous', margin: 20 }
                });

                if (format === 'pdf') {
                    const blob = await dlQr.getRawData('png');
                    const reader = new FileReader();
                    reader.readAsDataURL(blob);
                    reader.onloadend = () => {
                        const { jsPDF } = window.jspdf;
                        const doc = new jsPDF();
                        doc.text("QR Code", 105, 40, { align: "center" });
                        doc.addImage(reader.result, 'PNG', 55, 50, 100, 100); 
                        doc.save("qr.pdf");
                        resetStatus();
                    };
                } else {
                    await dlQr.download({ name: "qr", extension: format });
                    resetStatus();
                }
            } else {
                const canvas = document.querySelector('#qr-container canvas');
                let content = state.url || "123456";
                if (state.barcodeType === 'ean13') content = BarcodeEngine.ean13.validate(content);

                if (format === 'png') {
                    const link = document.createElement('a');
                    link.download = 'barcode.png';
                    link.href = canvas.toDataURL();
                    link.click();
                } else if (format === 'pdf') {
                     const { jsPDF } = window.jspdf;
                     const doc = new jsPDF();
                     const imgData = canvas.toDataURL('image/png');
                     const props = doc.getImageProperties(imgData);
                     const pdfWidth = 150;
                     const pdfHeight = (props.height * pdfWidth) / props.width;
                     doc.text("Barcode", 105, 40, { align: "center" });
                     doc.addImage(imgData, 'PNG', 30, 50, pdfWidth, pdfHeight);
                     doc.save("barcode.pdf");
                } else if (format === 'svg') {
                    const svgContent = BarcodeEngine.toSVGString(content, state.dotColor, els.showBarcodeText.checked, state.barcodeType);
                    const blob = new Blob([svgContent], {type: 'image/svg+xml'});
                    const link = document.createElement('a');
                    link.href = URL.createObjectURL(blob);
                    link.download = 'barcode.svg';
                    link.click();
                }
                resetStatus();
            }
        };

        function resetStatus() { els.status.innerText = "Ready to Scan"; els.status.style.background = "#f0f9eb"; }
    </script>
</body>
</html>
