<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ILLUS QR Code Studio</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Libraries -->
    <script src="https://unpkg.com/qr-code-styling@1.5.0/lib/qr-code-styling.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        /* Custom scrollbar for better aesthetics */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        /* Smooth transitions */
        .transition-all { transition-property: all; transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1); transition-duration: 300ms; }
    </style>
</head>
<body class="min-h-screen bg-gray-50 text-gray-800 font-sans">

    <div class="p-4 md:p-8">
        <div class="max-w-6xl mx-auto grid grid-cols-1 lg:grid-cols-12 gap-8">
            
            <!-- Header -->
            <div class="lg:col-span-12 mb-4 text-center">
                <h1 class="text-4xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-blue-600 to-purple-600 mb-2">
                    MHG QR Code Studio
                </h1>
                <p class="text-gray-500">Generate stylish QR codes with custom logos and images</p>
            </div>

            <!-- Left Column: Controls -->
            <div class="lg:col-span-5 space-y-6">
                
                <!-- Link Input Section -->
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                    <h2 class="text-lg font-semibold flex items-center gap-2 mb-4 text-gray-700">
                        <i data-lucide="link" class="text-blue-500 w-5 h-5"></i>
                        Content
                    </h2>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-600 mb-1">Target Website URL</label>
                            <input
                                type="text"
                                id="urlInput"
                                placeholder="https://example.com"
                                value="Enjoy your new QR"
                                class="w-full px-4 py-2 rounded-lg border border-gray-200 focus:border-blue-500 focus:ring-2 focus:ring-blue-100 outline-none transition-all"
                            />
                        </div>
                    </div>
                </div>

                <!-- Logo Section -->
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                    <h2 class="text-lg font-semibold flex items-center gap-2 mb-4 text-gray-700">
                        <i data-lucide="image" class="text-purple-500 w-5 h-5"></i>
                        Center Logo
                    </h2>
                    <div class="space-y-4">
                        <div class="flex items-center gap-2 mb-2">
                            <input
                                type="checkbox"
                                id="useFavicon"
                                checked
                                class="w-4 h-4 text-blue-600 rounded focus:ring-blue-500 cursor-pointer"
                            />
                            <label for="useFavicon" class="text-sm text-gray-600 select-none cursor-pointer">
                                Auto-fetch website logo (Favicon)
                            </label>
                        </div>
                        
                        <div id="customLogoContainer" class="transition-opacity duration-300 opacity-50 pointer-events-none">
                            <label class="block text-sm font-medium text-gray-600 mb-1">Or custom Image URL</label>
                            <input
                                type="text"
                                id="logoUrlInput"
                                placeholder="https://imgur.com/..."
                                class="w-full px-4 py-2 rounded-lg border border-gray-200 focus:border-purple-500 focus:ring-2 focus:ring-purple-100 outline-none transition-all"
                            />
                            <p class="text-xs text-gray-400 mt-1">Note: Image URL must allow CORS access.</p>
                        </div>
                    </div>
                </div>

                <!-- Style Controls -->
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                    <h2 class="text-lg font-semibold flex items-center gap-2 mb-4 text-gray-700">
                        <i data-lucide="settings" class="text-orange-500 w-5 h-5"></i>
                        Customization
                    </h2>
                    
                    <div class="space-y-6">
                        <!-- Dot Style -->
                        <div>
                            <label class="block text-xs font-bold text-gray-400 uppercase tracking-wider mb-2">Pattern Style</label>
                            <div class="grid grid-cols-3 gap-2" id="dotTypeContainer">
                                <!-- Generated by JS -->
                            </div>
                        </div>

                        <!-- Corner Style -->
                        <div>
                            <label class="block text-xs font-bold text-gray-400 uppercase tracking-wider mb-2">Corner Style</label>
                            <div class="flex gap-2" id="cornerTypeContainer">
                                <!-- Generated by JS -->
                            </div>
                        </div>

                        <!-- Colors -->
                        <div>
                            <label class="block text-xs font-bold text-gray-400 uppercase tracking-wider mb-2">Primary Color</label>
                            <div class="flex flex-wrap gap-2 mb-3" id="colorContainer">
                                <!-- Generated by JS -->
                                <div class="relative">
                                    <input 
                                        type="color" 
                                        id="colorPicker"
                                        value="#000000"
                                        class="w-8 h-8 rounded-full overflow-hidden border-0 p-0 cursor-pointer"
                                    />
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Column: Preview & Download -->
            <div class="lg:col-span-7 flex flex-col">
                <div class="sticky top-8 space-y-6">
                    
                    <!-- Preview Card -->
                    <div class="bg-white p-8 rounded-3xl shadow-xl border border-gray-100 flex flex-col items-center justify-center min-h-[500px] relative overflow-hidden">
                        <div class="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-blue-500 via-purple-500 to-pink-500"></div>
                        
                        <div class="absolute top-4 right-4 z-10">
                            <button 
                                id="refreshBtn"
                                class="p-2 text-gray-400 hover:text-blue-600 hover:bg-blue-50 rounded-full transition-colors"
                                title="Refresh Preview"
                            >
                                <i data-lucide="refresh-cw" class="w-5 h-5"></i>
                            </button>
                        </div>

                        <!-- The QR Code Container -->
                        <div 
                            id="qr-container" 
                            class="qr-container bg-white p-4 rounded-xl shadow-inner border border-gray-50 transition-all duration-300 transform hover:scale-[1.02] flex items-center justify-center min-h-[300px] min-w-[300px]"
                        ></div>

                        <div class="mt-8 text-center max-w-md">
                            <p id="urlDisplay" class="text-sm text-gray-400 break-all font-mono mb-2">Enjoy your new QR</p>
                            <div id="statusBadge" class="inline-block px-3 py-1 bg-green-50 text-green-700 text-xs font-medium rounded-full">
                                Ready to scan
                            </div>
                        </div>
                    </div>

                    <!-- Download Options -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <button onclick="handleDownload('png')" class="flex items-center justify-center gap-2 bg-gray-900 hover:bg-gray-800 text-white px-6 py-4 rounded-xl transition-all shadow-lg shadow-gray-200 active:scale-95 group">
                            <svg class="w-8 h-8 text-white opacity-80" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                            </svg>
                            <div class="text-left">
                                <div class="text-xs text-gray-400 font-medium">Download as</div>
                                <div class="font-bold">PNG</div>
                            </div>
                        </button>

                        <button onclick="handleDownload('svg')" class="flex items-center justify-center gap-2 bg-white hover:bg-gray-50 text-gray-900 border border-gray-200 px-6 py-4 rounded-xl transition-all shadow-lg shadow-gray-100 active:scale-95 group">
                            <svg class="w-8 h-8 text-gray-700 opacity-80" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M7 21a4 4 0 01-4-4V5a2 2 0 012-2h4a2 2 0 012 2v12a4 4 0 01-4 4zm0 0h12a2 2 0 002-2v-4a2 2 0 00-2-2h-2.343M11 7.343l1.657-1.657a2 2 0 012.828 0l2.829 2.829a2 2 0 010 2.828l-8.486 8.485M7 17h.01" />
                            </svg>
                            <div class="text-left">
                                <div class="text-xs text-gray-500 font-medium">Download as</div>
                                <div class="font-bold">SVG</div>
                            </div>
                        </button>

                        <button onclick="handleDownload('pdf')" class="flex items-center justify-center gap-2 bg-red-50 hover:bg-red-100 text-red-900 border border-red-100 px-6 py-4 rounded-xl transition-all shadow-lg shadow-red-50 active:scale-95 group">
                            <svg class="w-8 h-8 text-red-600 opacity-80" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z" />
                            </svg>
                            <div class="text-left">
                                <div class="text-xs text-red-400 font-medium">Download as</div>
                                <div class="font-bold">PDF</div>
                            </div>
                        </button>
                    </div>

                </div>
            </div>
        </div>
    </div>

    <script>
        // --- State Management ---
        let state = {
            url: 'Enjoy your new QR',
            logoUrl: '',
            useFavicon: true,
            dotType: 'dots',
            dotColor: '#000000',
            cornerType: 'extra-rounded',
            cornerColor: '#000000',
            bgColor: '#ffffff'
        };

        let qrCodeInstance = null;
        let isDownloading = false;
        let debounceTimer;

        // --- Elements ---
        const urlInput = document.getElementById('urlInput');
        const logoUrlInput = document.getElementById('logoUrlInput');
        const useFaviconCheckbox = document.getElementById('useFavicon');
        const customLogoContainer = document.getElementById('customLogoContainer');
        const qrContainer = document.getElementById('qr-container');
        const urlDisplay = document.getElementById('urlDisplay');
        const statusBadge = document.getElementById('statusBadge');
        const colorPicker = document.getElementById('colorPicker');
        const refreshBtn = document.getElementById('refreshBtn');

        // --- Configuration Constants ---
        const presetColors = [
            { name: 'Black', hex: '#000000' },
            { name: 'Blue', hex: '#2563EB' },
            { name: 'Purple', hex: '#7C3AED' },
            { name: 'Pink', hex: '#DB2777' },
            { name: 'Teal', hex: '#0D9488' },
            { name: 'Orange', hex: '#EA580C' },
        ];
        const dotTypes = ['dots', 'rounded', 'square', 'classy', 'classy-rounded', 'extra-rounded'];
        const cornerTypes = ['square', 'extra-rounded', 'dot'];

        // --- Helper: Convert Image to Base64 ---
        async function convertImageToBase64(url) {
            if (!url) return undefined;
            try {
                const response = await fetch(url);
                const blob = await response.blob();
                return new Promise((resolve) => {
                    const reader = new FileReader();
                    reader.onloadend = () => resolve(reader.result);
                    reader.readAsDataURL(blob);
                });
            } catch (error) {
                console.warn("Image conversion failed (CORS?):", error);
                return url; // Fallback
            }
        }

        // --- Helper: Get QR Options ---
        function getQrOptions(width, height, data, image) {
            return {
                width: width,
                height: height,
                type: 'svg',
                data: data,
                image: image,
                dotsOptions: {
                    color: state.dotColor,
                    type: state.dotType
                },
                backgroundOptions: {
                    color: state.bgColor,
                },
                imageOptions: {
                    crossOrigin: 'anonymous',
                    margin: 10
                },
                cornersSquareOptions: {
                    type: state.cornerType,
                    color: state.cornerColor
                }
            };
        }

        // --- Main Update Function ---
        async function updateQR() {
            if (!qrCodeInstance) return;

            const effectiveUrl = state.url || 'Enjoy your new QR';
            let activeLogoUrl = undefined;

            // Logic for logo selection
            if (state.useFavicon && !state.logoUrl && effectiveUrl && effectiveUrl.includes('http')) {
                try {
                    const urlObj = new URL(effectiveUrl);
                    if (urlObj.hostname.includes('.')) {
                        activeLogoUrl = `https://www.google.com/s2/favicons?domain=${urlObj.hostname}&sz=64`;
                    }
                } catch (e) { /* ignore */ }
            } else if (state.logoUrl && state.logoUrl.startsWith('http')) {
                activeLogoUrl = state.logoUrl;
            }

            // Update UI Text
            urlDisplay.textContent = effectiveUrl.length > 50 ? effectiveUrl.substring(0, 50) + '...' : effectiveUrl;

            // Convert Image
            const base64Image = activeLogoUrl ? await convertImageToBase64(activeLogoUrl) : undefined;

            // Update QR Instance
            qrCodeInstance.update(getQrOptions(300, 300, effectiveUrl, base64Image));

            // Failsafe: Re-append if missing
            if (qrContainer.innerHTML === '') {
                qrCodeInstance.append(qrContainer);
            }
        }

        // --- Initialization ---
        function init() {
            // Render Buttons
            renderStyleButtons();

            // Initialize QR Library
            qrCodeInstance = new QRCodeStyling(getQrOptions(300, 300, state.url, undefined));
            qrCodeInstance.append(qrContainer);

            // Trigger Icons
            lucide.createIcons();

            // Initial Update
            updateQR();
        }

        // --- UI Rendering Helpers ---
        function renderStyleButtons() {
            // Dot Types
            const dotContainer = document.getElementById('dotTypeContainer');
            dotContainer.innerHTML = dotTypes.map(type => `
                <button onclick="setDotType('${type}')" 
                    class="px-2 py-2 text-xs rounded-md border capitalize transition-all ${state.dotType === type ? 'bg-blue-50 border-blue-500 text-blue-700 font-medium' : 'bg-gray-50 border-transparent text-gray-600 hover:bg-gray-100'}">
                    ${type.replace('-', ' ')}
                </button>
            `).join('');

            // Corner Types
            const cornerContainer = document.getElementById('cornerTypeContainer');
            cornerContainer.innerHTML = cornerTypes.map(type => `
                <button onclick="setCornerType('${type}')" 
                    class="flex-1 px-2 py-2 text-xs rounded-md border capitalize transition-all ${state.cornerType === type ? 'bg-purple-50 border-purple-500 text-purple-700 font-medium' : 'bg-gray-50 border-transparent text-gray-600 hover:bg-gray-100'}">
                    ${type.replace('-', ' ')}
                </button>
            `).join('');

            // Colors
            const colorContainer = document.getElementById('colorContainer');
            // Remove old buttons first (keeping the picker)
            Array.from(colorContainer.children).forEach(child => {
                if(!child.querySelector('input')) child.remove();
            });
            
            const buttonsHTML = presetColors.map(color => `
                <button onclick="setColor('${color.hex}')" 
                    class="w-8 h-8 rounded-full border-2 transition-transform hover:scale-110 ${state.dotColor === color.hex ? 'border-gray-400 ring-2 ring-offset-2 ring-gray-200' : 'border-transparent'}"
                    style="background-color: ${color.hex}"
                    title="${color.name}">
                </button>
            `).join('');
            
            colorContainer.insertAdjacentHTML('afterbegin', buttonsHTML);
        }

        // --- Event Setters (exposed to window) ---
        window.setDotType = (type) => {
            state.dotType = type;
            renderStyleButtons();
            updateQR();
        };

        window.setCornerType = (type) => {
            state.cornerType = type;
            renderStyleButtons();
            updateQR();
        };

        window.setColor = (hex) => {
            state.dotColor = hex;
            state.cornerColor = hex;
            colorPicker.value = hex;
            renderStyleButtons();
            updateQR();
        };

        // --- Event Listeners ---
        
        // URL Input with Debounce
        urlInput.addEventListener('input', (e) => {
            clearTimeout(debounceTimer);
            state.url = e.target.value;
            debounceTimer = setTimeout(updateQR, 300);
        });

        // Logo URL Input
        logoUrlInput.addEventListener('input', (e) => {
            state.logoUrl = e.target.value;
            if(state.logoUrl) {
                state.useFavicon = false;
                useFaviconCheckbox.checked = false;
                customLogoContainer.classList.remove('opacity-50', 'pointer-events-none');
            }
            updateQR();
        });

        // Favicon Checkbox
        useFaviconCheckbox.addEventListener('change', (e) => {
            state.useFavicon = e.target.checked;
            if (state.useFavicon) {
                customLogoContainer.classList.add('opacity-50', 'pointer-events-none');
            } else {
                customLogoContainer.classList.remove('opacity-50', 'pointer-events-none');
            }
            updateQR();
        });

        // Color Picker
        colorPicker.addEventListener('input', (e) => {
            setColor(e.target.value);
        });

        // Refresh Button
        refreshBtn.addEventListener('click', () => {
            qrContainer.innerHTML = '';
            qrCodeInstance.append(qrContainer);
            updateQR();
        });

        // --- Download Handler ---
        window.handleDownload = async (format) => {
            if (isDownloading) return;
            isDownloading = true;
            statusBadge.textContent = "Generating High-Res File...";
            statusBadge.className = "inline-block px-3 py-1 bg-yellow-50 text-yellow-700 text-xs font-medium rounded-full";

            const effectiveUrl = state.url || 'Enjoy your new QR';
            let activeLogoUrl = undefined;
            if (state.useFavicon && !state.logoUrl && effectiveUrl && effectiveUrl.includes('http')) {
                try {
                    const urlObj = new URL(effectiveUrl);
                    if (urlObj.hostname.includes('.')) activeLogoUrl = `https://www.google.com/s2/favicons?domain=${urlObj.hostname}&sz=64`;
                } catch(e) {}
            } else if (state.logoUrl) {
                activeLogoUrl = state.logoUrl;
            }

            const base64Image = await convertImageToBase64(activeLogoUrl);

            // Create High-Res Instance (2000px)
            const downloadInstance = new QRCodeStyling(getQrOptions(2000, 2000, effectiveUrl, base64Image));

            try {
                if (format === 'pdf') {
                    const blob = await downloadInstance.getRawData('png');
                    const reader = new FileReader();
                    reader.readAsDataURL(blob);
                    reader.onloadend = () => {
                        const { jsPDF } = window.jspdf;
                        const doc = new jsPDF();
                        doc.text("Scan this QR Code", 105, 40, { align: "center" });
                        doc.addImage(reader.result, 'PNG', 55, 50, 100, 100); 
                        doc.text(effectiveUrl.substring(0, 50) + (effectiveUrl.length > 50 ? '...' : ''), 105, 160, { align: "center", maxWidth: 180 });
                        doc.save("qrcode.pdf");
                        finishDownload();
                    };
                } else {
                    await downloadInstance.download({ name: "qrcode", extension: format });
                    finishDownload();
                }
            } catch (err) {
                console.error(err);
                alert("Download failed. If using a custom logo, ensure it allows CORS.");
                finishDownload();
            }
        };

        function finishDownload() {
            isDownloading = false;
            statusBadge.textContent = "Ready to scan";
            statusBadge.className = "inline-block px-3 py-1 bg-green-50 text-green-700 text-xs font-medium rounded-full";
        }

        // Start App
        // Use a slight delay to ensure libraries load if using local file, 
        // though script tags usually block.
        window.onload = init;

    </script>
</body>
</html>

